# ESP32 控制步进电机

该项目使用 ESP32 控制三个相同的步进电机的正反转，通过四个按钮触发电机制的状态改变。项目使用 FreeRTOS 任务调度，利用定时器中断来实现步进电机的控制，并通过按钮触发电机的动作切换。

## 硬件连接

- **IN1、IN2、IN3、IN4 (Motor 1)**：连接第一个步进电机的四个控制引脚，用于控制电机的旋转方向和步进。
- **IN1、IN2、IN3、IN4 (Motor 2)**：连接第二个步进电机的四个控制引脚，用于控制电机的旋转方向和步进。
- **IN1、IN2、IN3、IN4 (Motor 3)**：连接第三个步进电机的四个控制引脚，用于控制电机的旋转方向和步进。
- **CONTROL_BUTTON_PIN**：连接到 GPIO 39 引脚，用于触发电机正反转。
- **SELECT_MOTOR1_PIN**：连接到 GPIO 40 引脚，用于选择控制第一个电机。
- **SELECT_MOTOR2_PIN**：连接到 GPIO 41 引脚，用于选择控制第二个电机。
- **SELECT_MOTOR3_PIN**：连接到 GPIO 42 引脚，用于选择控制第三个电机。

### 引脚定义

- `IN1_PIN_MOTOR1`: GPIO 4
- `IN2_PIN_MOTOR1`: GPIO 5
- `IN3_PIN_MOTOR1`: GPIO 6
- `IN4_PIN_MOTOR1`: GPIO 7
- `IN1_PIN_MOTOR2`: GPIO 9
- `IN2_PIN_MOTOR2`: GPIO 10
- `IN3_PIN_MOTOR2`: GPIO 11
- `IN4_PIN_MOTOR2`: GPIO 12
- `IN1_PIN_MOTOR3`: GPIO 15
- `IN2_PIN_MOTOR3`: GPIO 16
- `IN3_PIN_MOTOR3`: GPIO 17
- `IN4_PIN_MOTOR3`: GPIO 18
- `CONTROL_BUTTON_PIN`: GPIO 39
- `SELECT_MOTOR1_PIN`: GPIO 40
- `SELECT_MOTOR2_PIN`: GPIO 41
- `SELECT_MOTOR3_PIN`: GPIO 42

## 功能概述

### 1. 电机控制

该系统使用一个定时器来周期性地控制步进电机的步进，每 5ms 更新一次步进状态。电机的四个控制引脚（IN1~IN4）根据当前步进序列的值来设置，步进序列通过 `step_sequence` 数组预设。

### 2. 按钮触发

通过四个按钮（连接到 GPIO 39、40、41、42）触发电机制的状态切换：

- **控制按钮**（连接到 GPIO 39）：当该按钮高电平时，选中的电机正转；当该按钮低电平时，选中的电机反转。
- **选择电机 1 按钮**（连接到 GPIO 40）：当该按钮低电平时，选中电机 1。
- **选择电机 2 按钮**（连接到 GPIO 41）：当该按钮低电平时，选中电机 2。
- **选择电机 3 按钮**（连接到 GPIO 42）：当该按钮低电平时，选中电机 3。

### 3. 中断与队列

使用中断和队列来保证按钮按下事件的响应和电机控制状态的更新。

### 4. 定时器

利用 ESP32 的硬件定时器，每隔 5ms 触发一次步进电机的更新，以控制电机的旋转。

## 系统流程

1. **初始化**：
   - 配置三个步进电机的控制引脚（GPIO 4-7, 9-12, 15-18）。
   - 配置四个按钮引脚（GPIO 39, 40, 41, 42）并启用中断。
   - 初始化定时器，用于周期性更新电机的步进状态。

2. **按钮事件**：
   - 按下按钮时，通过中断触发事件，将事件发送到队列中。
   - 主任务从队列中接收事件，更新电机的状态（正转、反转）。

3. **步进控制**：
   - 电机的步进序列是通过 8 步序列的方式实现的，根据当前的电机状态更新步进的引脚值。

## 代码结构

### 1. `gpio_init()`

初始化步进电机控制引脚的输入输出模式，并配置四个按钮引脚的输入模式和中断类型。

### 2. `init_motor_timer()`

初始化定时器，用于定时更新步进电机的状态。定时器中断每 5 毫秒触发一次，调用 `on_timer_isr()` 更新步进电机的状态。

### 3. `motor_control_task()`

FreeRTOS 任务，负责接收按钮事件并根据当前的电机状态进行切换。电机状态根据按钮的状态更新：**正转、反转**。

### 4. `on_timer_isr()`

定时器中断服务程序，每隔 5ms 更新电机的步进状态。

### 5. `button_isr_handler()`

按钮中断服务程序，检测四个按钮的状态，并将事件放入队列中进行处理。

## 如何运行

1. 将代码上传到 ESP32 开发板。
2. 连接三个步进电机的控制引脚（IN1~IN4）到相应的硬件。
3. 将控制按钮连接到 GPIO 39 引脚。
4. 将选择电机 1 按钮连接到 GPIO 40 引脚。
5. 将选择电机 2 按钮连接到 GPIO 41 引脚。
6. 将选择电机 3 按钮连接到 GPIO 42 引脚。
7. 编译并上传代码到 ESP32 开发板。
8. 根据按钮的状态观察电机的旋转状态和日志输出。

## 示例

- 当 `SELECT_MOTOR1_PIN`（GPIO 40）低电平时，选中电机 1。
- 当 `SELECT_MOTOR2_PIN`（GPIO 41）低电平时，选中电机 2。
- 当 `SELECT_MOTOR3_PIN`（GPIO 42）低电平时，选中电机 3。
- 当 `CONTROL_BUTTON_PIN`（GPIO 39）高电平时，选中的电机正转。
- 当 `CONTROL_BUTTON_PIN`（GPIO 39）低电平时，选中的电机反转。
- 当没有按钮被选中时，电机停止。

通过这种方式，您可以灵活地控制三个步进电机的正转和反转，并且避开了指定的 GPIO 引脚。
